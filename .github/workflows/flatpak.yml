name: Build & Upload Flatpak

on:
  release:
    types: [created]         # fires when a new GitHub Release is created

jobs:
  flatpak:
    runs-on: ubuntu-22.04

    env:
      APP_ID: org.radiotube.vtun-ng           # keep in sync with flatpak.yml
      MANIFEST: flatpak/flatpak.yml
      ARCH: x86_64
      RUNTIME_VER: 23.08

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get -y install flatpak flatpak-builder python3

      - name: Add Flathub remote
        run: |
          flatpak --version          # debug
          flatpak remote-add --if-not-exists \
                 flathub https://dl.flathub.org/repo/flathub.flatpakrepo

      - name: Build with flatpak-builder
        run: |
          flatpak-builder \
            --user --disable-rofiles-fuse \
            --repo=repo build-dir "${MANIFEST}"

      - name: Create bundle
        run: |
          flatpak build-bundle repo "${APP_ID}.flatpak" "${APP_ID}" \
                 --runtime-repo=https://dl.flathub.org/repo/flathub.flatpakrepo \
                 --arch=${ARCH}

      - name: Upload .flatpak to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${APP_ID}.flatpak
